<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA PAULO 2.0 - GESTÃƒO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7f6; padding: 20px; font-family: 'Segoe UI', sans-serif; }
        .erp-card { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .nav-tabs .nav-link { cursor: pointer; font-weight: bold; color: #555; }
        .nav-tabs .nav-link.active { border-bottom: 4px solid #0d6efd; color: #0d6efd; }
        .aba-conteudo { display: none; padding-top: 20px; }
        .aba-ativa { display: block; }
        .bg-calculo { background: #e9ecef; border-radius: 10px; padding: 20px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="erp-card">
    <h3 class="text-center text-primary mb-4">ðŸ’Ž SISTEMA DE GESTÃƒO INTEGRADA</h3>

    <ul class="nav nav-tabs justify-content-center">
      <li class="nav-item"><a class="nav-link active" onclick="abrir('aba-estoque')">ðŸ“¦ ESTOQUE MP</a></li>
      <li class="nav-item"><a class="nav-link" onclick="abrir('aba-produtos')">ðŸš€ FICHA TÃ‰CNICA</a></li>
    </ul>

    <div id="aba-estoque" class="aba-conteudo aba-ativa">
        <h5>LanÃ§ar Entrada de Insumos (MatÃ©ria-Prima)</h5>
        <div class="row g-3 border p-3 rounded bg-light shadow-sm">
            <div class="col-md-2"><label class="fw-bold">CÃ³d:</label><input type="text" id="e_cod" class="form-control"></div>
            <div class="col-md-6"><label class="fw-bold">DescriÃ§Ã£o Insumo:</label><input type="text" id="e_prod" class="form-control"></div>
            <div class="col-md-4"><label class="fw-bold">Fornecedor:</label><input type="text" id="e_forn" class="form-control"></div>
            <div class="col-md-4"><label class="fw-bold">Quantidade:</label><input type="number" id="e_qde" class="form-control"></div>
            <div class="col-md-4"><label class="fw-bold">Vlr UnitÃ¡rio (R$):</label><input type="number" id="e_vlr" class="form-control"></div>
            <div class="col-md-4"><label>&nbsp;</label><button class="btn btn-primary w-100 fw-bold" onclick="salvarEstoque()">SALVAR ENTRADA</button></div>
        </div>
    </div>

    <div id="aba-produtos" class="aba-conteudo">
        <h5>Ficha TÃ©cnica e ComposiÃ§Ã£o do Produto</h5>
        <div class="row g-2 mb-3">
            <div class="col-md-3"><label>CÃ³d. Ref:</label><input type="text" id="p_cod" class="form-control"></div>
            <div class="col-md-9"><label>Produto Final:</label><input type="text" id="p_nome" class="form-control"></div>
        </div>

        <h6 class="mt-4">ComposiÃ§Ã£o de Insumos</h6>
        <table class="table table-sm border">
            <thead class="table-dark">
                <tr>
                    <th>MatÃ©ria-Prima</th>
                    <th width="120">Qtd Usada</th>
                    <th width="120">Vlr Unit.</th>
                    <th width="120">Subtotal</th>
                    <th width="40"></th>
                </tr>
            </thead>
            <tbody id="tabela_mp"></tbody>
        </table>
        <button class="btn btn-outline-secondary btn-sm mb-4" onclick="addLinhaMP()">+ Adicionar Insumo</button>

        <div class="bg-calculo shadow-sm">
            <div class="row g-3 align-items-end">
                <div class="col-md-3"><label class="fw-bold small">Custo MP (R$):</label><input type="text" id="p_custo_mp" class="form-control fw-bold" readonly value="0.00"></div>
                <div class="col-md-2"><label class="small fw-bold">Margem %:</label><input type="number" id="p_margem" class="form-control" value="50" oninput="calcularPreco()"></div>
                <div class="col-md-2"><label class="small fw-bold">Fixo %:</label><input type="number" id="p_fixo" class="form-control" value="15" oninput="calcularPreco()"></div>
                <div class="col-md-2"><label class="small fw-bold">CartÃ£o %:</label><input type="number" id="p_taxa" class="form-control" value="5" oninput="calcularPreco()"></div>
                <div class="col-md-3 text-end">
                    <label class="d-block small fw-bold">PREÃ‡O DE VENDA:</label>
                    <span class="h3 text-success fw-bold" id="vlr_final">R$ 0,00</span>
                </div>
            </div>
            <p class="text-muted small mt-2 mb-0">* Incluso automaticamente: Impostos (1%) e DepreciaÃ§Ã£o (0,5%)</p>
        </div>
        <button class="btn btn-success w-100 mt-4 p-3 fw-bold" onclick="salvarProduto()">SALVAR FICHA TÃ‰CNICA</button>
    </div>
</div>

<script>
    // âš ï¸ COLOQUE SEU LINK DO GOOGLE ABAIXO
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxptJfRSBxTmxJHyxFulO2zYWnrLAaZxd-U00VKITcp21rYTuExf7KYSOM05AR8qHoaBA/exec"; 

    function abrir(id) {
        document.querySelectorAll('.aba-conteudo').forEach(a => a.classList.remove('aba-ativa'));
        document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
        document.getElementById(id).classList.add('aba-ativa');
        event.currentTarget.classList.add('active');
    }

    function addLinhaMP() {
        const tabela = document.getElementById('tabela_mp');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm" placeholder="Insumo"></td>
            <td><input type="number" class="form-control form-control-sm qtd" value="1" oninput="calcularPreco()"></td>
            <td><input type="number" class="form-control form-control-sm vlr" value="0" oninput="calcularPreco()"></td>
            <td class="sub fw-bold">0.00</td>
            <td><button class="btn btn-sm text-danger" onclick="this.parentElement.parentElement.remove(); calcularPreco()">âœ•</button></td>
        `;
        tabela.appendChild(tr);
    }

    function calcularPreco() {
        let totalMP = 0;
        document.querySelectorAll('#tabela_mp tr').forEach(linha => {
            const q = parseFloat(linha.querySelector('.qtd').value) || 0;
            const v = parseFloat(linha.querySelector('.vlr').value) || 0;
            const sub = q * v;
            linha.querySelector('.sub').innerText = sub.toFixed(2);
            totalMP += sub;
        });
        document.getElementById('p_custo_mp').value = totalMP.toFixed(2);

        const m = parseFloat(document.getElementById('p_margem').value) || 0;
        const f = parseFloat(document.getElementById('p_fixo').value) || 0;
        const t = parseFloat(document.getElementById('p_taxa').value) || 0;
        const imp_dep = 1.5; // (1% + 0.5%)

        const markup = 1 - ((m + f + t + imp_dep) / 100);
        const venda = totalMP / (markup > 0 ? markup : 1);
        document.getElementById('vlr_final').innerText = "R$ " + venda.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    }

    async function salvarEstoque() {
        const dados = {
            action: "addEstoque",
            cod: document.getElementById('e_cod').value,
            prod: document.getElementById('e_prod').value,
            forn: document.getElementById('e_forn').value,
            qde: document.getElementById('e_qde').value,
            vlr: document.getElementById('e_vlr').value
        };
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(dados) });
        alert("Estoque Atualizado!");
        location.reload();
    }

    async function salvarProduto() {
        const dados = {
            action: "addProduto",
            cod: document.getElementById('p_cod').value,
            prod: document.getElementById('p_nome').value,
            total: document.getElementById('vlr_final').innerText
        };
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(dados) });
        alert("Produto e Ficha TÃ©cnica Salvos!");
    }

    window.onload = addLinhaMP;
</script>
</body>
</html>
