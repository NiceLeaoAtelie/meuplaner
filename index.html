<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA PAULO 2.0 - GEST√ÉO DE ESTOQUE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7f6; padding: 10px; font-size: 14px; }
        .container-erp { max-width: 950px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .aba-conteudo { display: none; padding-top: 20px; }
        .aba-ativa { display: block; }
        .nav-link { cursor: pointer; font-weight: bold; color: #666; }
        .nav-link.active { color: #0d6efd !important; border-bottom: 3px solid #0d6efd !important; }
        .bg-calculo { background: #f8f9fa; border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container-erp">
    <h4 class="text-center text-primary mb-4">üíé GEST√ÉO DE ESTOQUE E CUSTOS</h4>

    <ul class="nav nav-tabs justify-content-center">
      <li class="nav-item"><a class="nav-link" onclick="abrirAba('aba-vendas')">PEDIDOS</a></li>
      <li class="nav-item"><a class="nav-link" onclick="abrirAba('aba-estoque')">ENTRADA MAT√âRIA-PRIMA</a></li>
      <li class="nav-item"><a class="nav-link active" onclick="abrirAba('aba-produtos')">FICHA T√âCNICA</a></li>
    </ul>

    <div id="aba-estoque" class="aba-conteudo">
        <h5>üì¶ Entrada de Materiais (Compra)</h5>
        <div class="row g-2 card p-3 shadow-sm">
            <div class="col-md-2"><label>C√≥d. MP:</label><input type="text" id="e_cod" class="form-control"></div>
            <div class="col-md-6"><label>Descri√ß√£o do Insumo:</label><input type="text" id="e_prod" class="form-control" placeholder="Ex: Tecido Algod√£o Preto"></div>
            <div class="col-md-4"><label>Fornecedor:</label><input type="text" id="e_forn" class="form-control"></div>
            <div class="col-md-3"><label>Data Compra:</label><input type="date" id="e_data" class="form-control"></div>
            <div class="col-md-3"><label>Quantidade:</label><input type="number" id="e_qde" class="form-control"></div>
            <div class="col-md-3"><label>Vlr. Unit√°rio:</label><input type="number" id="e_vlr" class="form-control"></div>
            <div class="col-md-3"><label>&nbsp;</label><button class="btn btn-primary w-100" onclick="salvarEstoque()">DAR ENTRADA</button></div>
        </div>
    </div>

    <div id="aba-produtos" class="aba-conteudo aba-ativa">
        <h5>üöÄ Engenharia do Produto</h5>
        <div class="row g-2 mb-3 border-bottom pb-3">
            <div class="col-md-2"><label>C√≥d. Ref:</label><input type="text" id="p_cod" class="form-control"></div>
            <div class="col-md-10"><label>Nome do Produto Final:</label><input type="text" id="p_nome" class="form-control" placeholder="Ex: Camiseta Estampada Mod. A"></div>
        </div>

        <h6>üìù Composi√ß√£o de Insumos</h6>
        <table class="table table-sm border">
            <thead class="table-light">
                <tr>
                    <th>Mat√©ria-Prima</th>
                    <th width="120">Qtd Usada</th>
                    <th width="120">Custo (Estoque)</th>
                    <th width="120">Subtotal</th>
                    <th width="40"></th>
                </tr>
            </thead>
            <tbody id="tabela_mp"></tbody>
        </table>
        <button class="btn btn-outline-secondary btn-sm mb-4" onclick="addLinhaMP()">+ Incluir Insumo</button>

        <div class="bg-calculo">
            <div class="row g-3">
                <div class="col-md-3"><label>Custo Total MP:</label><input type="text" id="p_custo_total_mp" class="form-control fw-bold" readonly value="0.00"></div>
                <div class="col-md-2"><label>Margem %:</label><input type="number" id="p_margem" class="form-control" oninput="calcFinal()" value="50"></div>
                <div class="col-md-2"><label>Fixo %:</label><input type="number" id="p_fixo" class="form-control" oninput="calcFinal()" value="15"></div>
                <div class="col-md-2"><label>Cart√£o %:</label><input type="number" id="p_taxa" class="form-control" oninput="calcFinal()" value="5"></div>
                <div class="col-md-3 text-end">
                    <label class="d-block">PRE√áO DE VENDA:</label>
                    <span class="h3 text-success" id="vlr_final">R$ 0,00</span>
                </div>
            </div>
        </div>
        <button class="btn btn-success w-100 mt-3 p-3 fw-bold" onclick="salvarProduto()">SALVAR PRODUTO NO BANCO DE DADOS</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxptJfRSBxTmxJHyxFulO2zYWnrLAaZxd-U00VKITcp21rYTuExf7KYSOM05AR8qHoaBA/exec";

    function abrirAba(id) {
        document.querySelectorAll('.aba-conteudo').forEach(a => a.classList.remove('aba-ativa'));
        document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
        document.getElementById(id).classList.add('aba-ativa');
        event.currentTarget.classList.add('active');
    }

    // --- FUN√á√ïES DE ESTOQUE ---
    async function salvarEstoque() {
        const dados = {
            action: "addEstoque",
            cod: document.getElementById('e_cod').value,
            prod: document.getElementById('e_prod').value,
            forn: document.getElementById('e_forn').value,
            data: document.getElementById('e_data').value,
            qde: document.getElementById('e_qde').value,
            vlr: document.getElementById('e_vlr').value
        };
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(dados) });
        alert("Entrada de estoque realizada!");
        location.reload();
    }

    // --- FUN√á√ïES DE FICHA T√âCNICA ---
    function addLinhaMP() {
        const tabela = document.getElementById('tabela_mp');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm" placeholder="Nome da MP"></td>
            <td><input type="number" class="form-control form-control-sm mp-qtd" oninput="calcTotalMP()" value="1"></td>
            <td><input type="number" class="form-control form-control-sm mp-vlr" oninput="calcTotalMP()" value="0"></td>
            <td class="mp-subtotal fw-bold">0.00</td>
            <td><button class="btn btn-sm text-danger" onclick="this.parentElement.parentElement.remove(); calcTotalMP()">‚úï</button></td>
        `;
        tabela.appendChild(tr);
    }

    function calcTotalMP() {
        let total = 0;
        document.querySelectorAll('#tabela_mp tr').forEach(linha => {
            const q = parseFloat(linha.querySelector('.mp-qtd').value) || 0;
            const v = parseFloat(linha.querySelector('.mp-vlr').value) || 0;
            const sub = q * v;
            linha.querySelector('.mp-subtotal').innerText = sub.toFixed(2);
            total += sub;
        });
        document.getElementById('p_custo_total_mp').value = total.toFixed(2);
        calcFinal();
    }

    function calcFinal() {
        const custo = parseFloat(document.getElementById('p_custo_total_mp').value) || 0;
        const perc = (parseFloat(document.getElementById('p_margem').value) || 0) + 
                     (parseFloat(document.getElementById('p_fixo').value) || 0) + 
                     (parseFloat(document.getElementById('p_taxa').value) || 0) + 1.5;
        
        const markup = 1 - (perc / 100);
        const venda = custo / (markup > 0 ? markup : 1);
        document.getElementById('vlr_final').innerText = "R$ " + venda.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    }

    async function salvarProduto() {
        const dados = {
            action: "addProduto",
            cod: document.getElementById('p_cod').value,
            prod: document.getElementById('p_nome').value,
            custo: document.getElementById('p_custo_total_mp').value,
            margem: document.getElementById('p_margem').value,
            fixo: document.getElementById('p_fixo').value,
            taxa: document.getElementById('p_taxa').value,
            total: document.getElementById('vlr_final').innerText
        };
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(dados) });
        alert("Ficha t√©cnica salva!");
    }

    window.onload = () => { addLinhaMP(); };
</script>
</body>
</html>
