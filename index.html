<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA PAULO 2.0 - ERP ARROJADO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7f6; padding: 10px; }
        .container-erp { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .nav-tabs .nav-link { color: #555; font-weight: bold; cursor: pointer; }
        .nav-tabs .nav-link.active { border-bottom: 4px solid #0d6efd; color: #0d6efd; }
        .aba-conteudo { display: none; padding-top: 20px; }
        .aba-ativa { display: block; }
        .card-calculo { background: #e9ecef; border-radius: 10px; padding: 15px; margin-top: 15px; }
        .btn-salvar { background: #28a745; color: white; font-weight: bold; width: 100%; padding: 15px; border: none; border-radius: 8px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container-erp">
    <h3 class="text-center mb-4 text-primary">üìä GEST√ÉO INTEGRADA PAULO</h3>

    <ul class="nav nav-tabs justify-content-center" id="menu">
      <li class="nav-item"><a class="nav-link active" onclick="abrirAba('aba-vendas')">PEDIDOS</a></li>
      <li class="nav-item"><a class="nav-link" onclick="abrirAba('aba-clientes')">CLIENTES</a></li>
      <li class="nav-item"><a class="nav-link" onclick="abrirAba('aba-produtos')">FICHA T√âCNICA</a></li>
      <li class="nav-item"><a class="nav-link" onclick="abrirAba('aba-estoque')">ESTOQUE MP</a></li>
    </ul>

    <div id="aba-produtos" class="aba-conteudo aba-ativa">
        <h5>üöÄ Cadastro de Produto Final & Custos</h5>
        <div class="row g-2 mb-3">
            <div class="col-md-3"><label class="small fw-bold">C√≥d. Produto:</label><input type="text" id="p_cod" class="form-control"></div>
            <div class="col-md-9"><label class="small fw-bold">Nome do Produto:</label><input type="text" id="p_nome" class="form-control"></div>
        </div>

        <h6 class="mt-4">üõ†Ô∏è Composi√ß√£o de Mat√©ria-Prima (MP)</h6>
        <table class="table table-sm table-hover border">
            <thead class="table-dark">
                <tr>
                    <th>Insumo / Mat√©ria-Prima</th>
                    <th width="120">Qtd</th>
                    <th width="120">Custo Un.</th>
                    <th width="120">Subtotal</th>
                    <th width="40"></th>
                </tr>
            </thead>
            <tbody id="tabela_mp">
                </tbody>
        </table>
        <button class="btn btn-outline-primary btn-sm mb-3" onclick="addLinhaMP()">+ Adicionar Insumo</button>

        <div class="card-calculo">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="small fw-bold">Custo Total MP (R$):</label>
                    <input type="text" id="p_custo_total_mp" class="form-control fw-bold text-danger" readonly value="0.00">
                </div>
                <div class="col-md-2"><label class="small fw-bold">Margem %:</label><input type="number" id="p_margem" class="form-control" oninput="calcularPrecoFinal()" value="30"></div>
                <div class="col-md-2"><label class="small fw-bold">C.Fixo %:</label><input type="number" id="p_fixo" class="form-control" oninput="calcularPrecoFinal()" value="15"></div>
                <div class="col-md-2"><label class="small fw-bold">Cart√£o %:</label><input type="number" id="p_taxa" class="form-control" oninput="calcularPrecoFinal()" value="5"></div>
                <div class="col-md-2"><label class="small fw-bold">Imp/Dep %:</label><input type="text" class="form-control bg-secondary-subtle" readonly value="1.5"></div>
            </div>
            <div class="text-center mt-3">
                <h4 class="text-success">PRE√áO DE VENDA SUGERIDO: <span id="vlr_final">R$ 0,00</span></h4>
            </div>
        </div>
        <button class="btn-salvar" onclick="salvarProduto()">SALVAR FICHA T√âCNICA NO BANCO</button>
    </div>

    <div id="aba-vendas" class="aba-conteudo">
        <div class="alert alert-info">O M√≥dulo de Pedidos com 10 itens e Gerador de PDF est√° sendo integrado ao banco de dados...</div>
    </div>
    <div id="aba-clientes" class="aba-conteudo">
        <h5>üë• Cadastro de Clientes</h5>
        <div class="row g-2">
            <div class="col-md-12"><input type="text" class="form-control" placeholder="Nome Completo"></div>
            <div class="col-md-6"><input type="text" class="form-control" placeholder="WhatsApp"></div>
            <div class="col-md-6"><input type="text" class="form-control" placeholder="Cidade"></div>
            <button class="btn btn-primary mt-2">Cadastrar Cliente</button>
        </div>
    </div>
    <div id="aba-estoque" class="aba-conteudo">
        <h5>üì¶ Entrada de Mat√©ria-Prima</h5>
        <p class="small">Lan√ßamento de notas e aumento de estoque.</p>
    </div>

</div>

<script>
    // ‚ö†Ô∏è COLOQUE SUA URL DO GOOGLE ABAIXO
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxptJfRSBxTmxJHyxFulO2zYWnrLAaZxd-U00VKITcp21rYTuExf7KYSOM05AR8qHoaBA/exec"; 

    // Inicia com uma linha de MP
    window.onload = () => { addLinhaMP(); };

    function abrirAba(id) {
        document.querySelectorAll('.aba-conteudo').forEach(a => a.classList.remove('aba-ativa'));
        document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
        document.getElementById(id).classList.add('aba-ativa');
        event.currentTarget.classList.add('active');
    }

    function addLinhaMP() {
        const tabela = document.getElementById('tabela_mp');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm mp-nome" placeholder="Ex: Tecido, Linha, Bot√£o"></td>
            <td><input type="number" class="form-control form-control-sm mp-qtd" oninput="calcMP()" value="1"></td>
            <td><input type="number" class="form-control form-control-sm mp-vlr" oninput="calcMP()" value="0"></td>
            <td class="mp-subtotal fw-bold">0.00</td>
            <td><button class="btn btn-sm text-danger" onclick="this.parentElement.parentElement.remove(); calcMP()">‚úï</button></td>
        `;
        tabela.appendChild(tr);
    }

    function calcMP() {
        let total = 0;
        document.querySelectorAll('#tabela_mp tr').forEach(linha => {
            const q = parseFloat(linha.querySelector('.mp-qtd').value) || 0;
            const v = parseFloat(linha.querySelector('.mp-vlr').value) || 0;
            const sub = q * v;
            linha.querySelector('.mp-subtotal').innerText = sub.toFixed(2);
            total += sub;
        });
        document.getElementById('p_custo_total_mp').value = total.toFixed(2);
        calcularPrecoFinal();
    }

    function calcularPrecoFinal() {
        const custo = parseFloat(document.getElementById('p_custo_total_mp').value) || 0;
        const margem = parseFloat(document.getElementById('p_margem').value) || 0;
        const fixo = parseFloat(document.getElementById('p_fixo').value) || 0;
        const taxa = parseFloat(document.getElementById('p_taxa').value) || 0;
        const imp_dep = 1.5;

        const totalPerc = margem + fixo + taxa + imp_dep;
        const markup = 1 - (totalPerc / 100);
        const venda = custo / (markup > 0 ? markup : 1);

        document.getElementById('vlr_final').innerText = "R$ " + venda.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    }

    async function salvarProduto() {
        const btn = event.target;
        btn.disabled = true;
        btn.innerText = "SALVANDO NO GOOGLE SHEETS...";

        const dados = {
            action: "addProduto",
            cod: document.getElementById('p_cod').value,
            prod: document.getElementById('p_nome').value,
            custo: document.getElementById('p_custo_total_mp').value,
            margem: document.getElementById('p_margem').value,
            fixo: document.getElementById('p_fixo').value,
            taxa: document.getElementById('p_taxa').value,
            total: document.getElementById('vlr_final').innerText
        };

        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(dados) });
            alert("Produto e Ficha T√©cnica salvos!");
            location.reload();
        } catch(e) {
            alert("Erro ao salvar.");
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
